<!DOCTYPE html>
<html>

  <head>
    <title>Karsquares 2</title>
  	<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro|Montserrat" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.5.2/randomColor.min.js"></script>
    <script data-require="d3@4.0.0" data-semver="4.0.0" src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/susielu/d3-legend/master/d3-legend.min.js"></script>
<style>
    div.tooltip {   
          position: absolute;           
          text-align: center;           
          width: 15%;                  
          height: 9%;                 
          padding: 2px;             
          font: 1vw 'Source Sans Pro';        
          background: white;   
          border: 0px;      
          border-radius: 0px;           
          pointer-events: none;         
}

      .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: 'Source Sans Pro';
            font-size: 20px;
        }

        .label {
          font-family: 'Source Sans Pro';
          font-size: 15px;
        }

        .d3-legend text {
          font-family: 'Source Sans Pro';
          font-size: 15px;
        }

</style>
  </head>

  <body>


    <div id = 'graph1'></div>
    
    <script>

    var jsonData;

    d3.json("data.json", function(data){
      jsonData = data;
    })

    var mydata = JSON.parse(jsonData);

    var topParties = ['INC', 'IND', 'BJP', 'None', 'JD(S)', 'BSRCP', 'KJP', 'SP', 'JP', 'JD', 'INC(I)', 'JNP(JP)', 'JD(U)']

            for (i = 0; i < mydata.length; i++) {
            	if (typeof(mydata[i].Last_party) === 'undefined') {
            		mydata[i].Last_party = 'None';
            	}
              if (!(topParties.includes(mydata[i].Party)) && !(topParties.includes(mydata[i].Last_party))) {
                mydata[i].Oth_Current = mydata[i].Party;
                mydata[i].Party = 'Other';
                mydata[i].Oth_Last = mydata[i].Last_party;
                mydata[i].Last_party = 'Other';
              }
              else if (!(topParties.includes(mydata[i].Party))) {
                mydata[i].Oth_Current = mydata[i].Party;
                mydata[i].Party = 'Other';
              }
              else if (!(topParties.includes(mydata[i].Last_party))) {
                mydata[i].Oth_Last = mydata[i].Last_party;
                mydata[i].Last_party = 'Other';
              }
            }


            //get list of all parties
            var allParties = []
            for (i = 0; i < mydata.length; i++) {
              if (!(allParties.includes(mydata[i].Party))) {
                allParties.push(mydata[i].Party);
              }
              if (!(allParties.includes(mydata[i].Last_party))) {
                allParties.push(mydata[i].Last_party);
              }
            }

            //generate colour range for parties
            var colourRange = randomColor({
               count: allParties.length,
               luminosity: 'bright',
               format: 'rgb' // e.g. 'rgb(225,200,20)' 
            });

            //dict of party and colour
            var partyColours = {}
            for (i = 0; i < allParties.length; i++) {
                partyColours[allParties[i]] = colourRange[i];
            }

            partyColours['BJP'] = '#ff9933'
            partyColours['INC'] = '#138808'
            partyColours['INC(I)'] = '#138808'
            partyColours['IND'] = '#008080'
            partyColours['JD'] = '#90f887'
            partyColours['AIRJP'] = '#009999'
            partyColours['SP'] = '#990000'
            partyColours['JD(U)'] = '#90f887'
            partyColours['NCP'] = '#99003d'
            partyColours['BJNKP'] = '#333300'
            partyColours['GPP'] = '#ffcc00'
            partyColours['None'] = '#707070'

            var partyNames = {'INC': 'Indian National Congress', 'KJP': 'Karnataka Janata Paksha', 'IND': 'Independent', 'CPI': 'Communist Party of India', 'JD(S)': 'Janata Dal (Secular)', 'BLD': 'Bharatiya Lok Dal', 'SP': 'Samajwadi Party', 'RMP': 'Revolutionary Marxist Party', 'INC(I)': 'Indian National Congress (I)', 'JNP(JP)': 'Janata Party', 'BJP': 'Bharatiya Janata Party', 'JNP(SC)': 'Janata Party (SC)', 'JNP': 'Janata Party', 'JD': 'Janata Dal', 'AIRJP': 'All India Rashtriya Janata Party', 'JD(U)': 'Janata Dal United', 'NCP': 'National Communist Party', 'None': 'None', 'Other': 'Other', 'BSRCP': 'Badagara Shramika Raitala Congress', 'JP': 'Janata Party'}

    var rowMax = 20;

    var assemblyNo = 9;

    var div = d3.select("body").append("div")   
                            .attr("class", "tooltip")               
                            .style("opacity", 0); 

            //get current assembly parties
            var currentAssembly = mydata.filter(function(i) {
              return i.Assembly_No === assemblyNo;
            });

            var lookup = {};
            var items = currentAssembly;
            var parties = [];

            for (var item, i = 0; item = items[i++];) {
              var Party = item.Party;

              if (!(Party in lookup)) {
                lookup[Party] = 1;
                parties.push(Party);
              }
            }

            //get current assembly entries by party
            var partywise = []
            for (i = 0; i < parties.length; i++) {
              var currentParty = parties[i];
              var currentEntries = currentAssembly.filter(function(i) {
                if (currentParty == 'IND') {
                  return (i.Party === currentParty && i.Last_party != 'None');
                }
                else {
                  return (i.Party === currentParty);
                }
            });
              partywise.push(currentEntries);

            }

            //get parties for legend
            var legendParties = []
            for (i = 0; i < partywise.length; i++) {
              for (j = 0; j < partywise[i].length; j++) {
                if (!(legendParties.includes(partywise[i][j].Party))) {
                legendParties.push(partywise[i][j].Party);
              }
              if (!(legendParties.includes(partywise[i][j].Last_party))) {
                legendParties.push(partywise[i][j].Last_party);
              }
              }
            }

            //get colour range for legend parties
            var legendColours = []
            for (i = 0; i < legendParties.length; i++) {
              legendColours.push(partyColours[legendParties[i]])
            }

            //declare colour scale
            var colourScale = d3.scaleOrdinal()
              .domain(legendParties)
              .range(legendColours);
         
    var xMax = 0;
    for (k = 0; k < partywise.length; k++) {
    	if (partywise[k].length > xMax) {
    		xMax = partywise[k].length;
    	}
    }


    var symbolSize = 180
    var rowMax = 5
    var squareDim = 12, // pixel dimensions of square
        // width = xMax * 17; // horizontal
        // height = partywise.length * (squareDim + 2); // horizontal
    width = (rowMax + 1) * partywise.length * (Math.sqrt(symbolSize) + 3); // horizontal
    var height = 1000; //vertical
    var legendMargin = 300
    var topMargin = 30

    // var xscale = d3.scaleLinear()
    //                .domain([0, partywise.length])
    //                .range([0, width]);

    // var x_axis = d3.axisBottom()
    //                .scale(xscale)
    //                .ticks((partywise.length-1))
    //                .tickFormat(function(d, i){
    //                     return parties[i];
    //                 });

        
    var svg = d3.select('body')
      .append('svg')
      .attr('width', width+legendMargin)
      .attr('height', height);

    // var xAppend = svg.append("g")
    //                         .attr("class", "xaxis")
    //                         .attr("transform", "translate(0," + (20) + ")")
    //                         .call(x_axis)

    // var labelMove = svg.selectAll(".xaxis text")
    //             .attr("transform", function(d) {
    //               //  return "translate(" + this.getBBox().width*8 + "," + (this.getBBox().height + 5) + ")rotate(-45)";
    //               return "translate(" + (width/partywise.length)/2 + ",-20)rotate(0)"
    //                 });

     col = -rowMax
     row = -1
     for (k=0; k<partywise.length; k++) {
      svg.selectAll('u')
        .data(partywise[k])
        .enter()
        .append('path')
        .attr('d', d3.symbol().type(function(d) {
          if (d.Won == 'Yes') {
            return d3.symbolSquare;
          }
          else {
            return d3.symbolCircle;
          }
        })
        .size(function(d, i) {
          return symbolSize;
        }))
        .attr("transform", function(d, i) {
          if (i == 0) {
          col += rowMax + 1;
        }
          var x = ((i % rowMax) + col) * (symbolSize / 11);
          if (i % rowMax == 0 && i != 0) {
          row += 1;
        }
          if (i == 0) {
            row = 0;
          }
          var y = (row +2) * (symbolSize/10);
        return "translate(" + x + "," + y + ")"
        })
        .attr("currentParty", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            else if (d.Party === 'Other') {
              return (partyNames[d.Oth_Current]);
            }
          else {
              return (partyNames[d.Party]);}
          })
        .attr("lastParty", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            if (typeof(d.Last_party) === 'undefined') {
              return ('None');
            }
            else if (d.Last_party === 'Other') {
              return partyNames[d.Oth_Last];
            }
            else {
                return partyNames[d.Last_party];}
            })
        .attr("name", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            else {
                return (d.Candidate);}
            })
        .style("fill", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            if (typeof(d.Last_party) === 'undefined') {
                return partyColours['None'];
            }
            else {
                return partyColours[d.Last_party];
            }
          })
        // .style("opacity", function(d, i) {
        // 	if (d.Won === 'No') {
        // 		return 0.5;
        // 	}
        //  })
        .on("mouseover", function(d, i) {
                                d3.select(this)
                                  .transition()
                                  .duration(200)
                                  .style('opacity', 0.5)
                                div.transition()    
                                    .duration(200)    
                                    .style("opacity", .9); 
                                    div .html(d3.select(this).attr("name") + "<br/>Previously: " + d3.select(this).attr("lastParty") + "<br/>Now: " + d3.select(this).attr("currentParty"))
                                //div .html(Math.round(this.getBBox().height/hFactor) + "<br/>")
                                    .style("left", (d3.event.pageX) + "px")   
                                    .style("top", (d3.event.pageY - 28) + "px");  
                                })          
                            .on("mouseout", function(d) { 
                                d3.select(this)
                                  .transition()
                                  .duration(200)
                                  .style('opacity', 1) 
                                div.transition()    
                                    .duration(500)    
                                    .style("opacity", 0); 
                            });
        }

     col = -rowMax
     row = -1
     letterArray = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i']
     for (j = 0; j < partywise.length; j++) {
      svg.selectAll(letterArray[j])
        .data(partywise[j])
        .enter()
        .append('text')
        .attr("x", function(d, i) {
          if (i == 0) {
          col += rowMax + 1;
        }
        if (d.Contested > 9) {
          return ((i % rowMax) + col) * (symbolSize / 11) - 7;
        }
        else {
          return ((i % rowMax) + col) * (symbolSize / 11) - 4;          
        }

        })
        .attr("y", function(d, i) {
          if (i % rowMax == 0 && i != 0) {
          row += 1;
        }
          if (i == 0) {
            row = 0;
          }
          if (d.Party == 'JD(U)') {
            console.log(d.Contested);
          }
          return (row + 2) * (symbolSize/10) + 4;
        })
        .text(function(d) {
          if (d.Contested > 1) {
            return d.Contested;
          }
        })
        .attr("currentParty", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            else if (d.Party === 'Other') {
              return (partyNames[d.Oth_Current]);
            }
          else {
              return (partyNames[d.Party]);}
          })
        .attr("lastParty", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            if (typeof(d.Last_party) === 'undefined') {
              return ('None');
            }
            else if (d.Last_party === 'Other') {
              return partyNames[d.Oth_Last];
            }
            else {
                return partyNames[d.Last_party];}
            })
        .attr("name", function(d, i) {
            if (typeof(d) === 'undefined') {
                return 0;
            }
            else {
                return (d.Candidate);}
            })
        .style("fill", 'white')
        .style("font-family", 'Montserrat')
        .style("font-size", function(d) {
          if (d.Contested > 9) {
            return '10px';
          }
          else {
            return '11px';
          }
        })
        .on("mouseover", function(d, i) {
                                div.transition()    
                                    .duration(200)    
                                    .style("opacity", .9); 
                                    div .html(d3.select(this).attr("name") + "<br/>Previously: " + d3.select(this).attr("lastParty") + "<br/>Now: " + d3.select(this).attr("currentParty"))
                                //div .html(Math.round(this.getBBox().height/hFactor) + "<br/>")
                                    .style("left", (d3.event.pageX) + "px")   
                                    .style("top", (d3.event.pageY - 28) + "px");  
                                })          
                            .on("mouseout", function(d) { 
                                div.transition()    
                                    .duration(500)    
                                    .style("opacity", 0); 
                            });
      }

      //create legend
            svg.append("g")
              .attr("class", "legendOrdinal")
              .attr("transform", "translate(" + 0 +"," + 10 + ")");

            var legendOrdinal = d3.legendColor()
              .orient('horizontal')
              //.shape("path", d3.symbol().type(d3.symbolTriangle).size(100)())
              .shapeWidth(25)
              .shapePadding(50)
              .scale(colourScale);

            svg.select(".legendOrdinal")
                .call(legendOrdinal);

      //create symbol legend
      circle = d3.symbol().type(d3.symbolCircle).size(200)();
      square = d3.symbol().type(d3.symbolSquare).size(200)();

      var symbolScale =  d3.scaleOrdinal()
        .domain(['Winner in previous election','Loser in previous election'])
        .range([square, circle] );

      var svg = d3.select("svg");

      svg.append("g")
        .attr("class", "legendSymbol")
        .attr("transform", "translate("+ (width + 20) +", 350)");

      var legendPath = d3.legendSymbol()
        .scale(symbolScale)
        .orient("vertical")


      svg.select(".legendSymbol")
        .call(legendPath);
                            


    </script>
    
  </body>

</html>